<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Ensayos</title>
    <!-- Incluir la fuente Inter de Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Incluir el CDN de Tailwind CSS para un diseño moderno y responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Incluir el CDN de Chart.js para gráficos estadísticos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0,0,0);
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 24px;
            border-radius: 1rem;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .close-button {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .progress-bar {
            height: 8px;
            background-color: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background-color: #4f46e5;
            transition: width 1s linear;
        }
    </style>
</head>
<body class="bg-indigo-50 flex flex-col items-center min-h-screen p-4">

    <!-- Vista de Login -->
    <div id="login-view" class="w-full max-w-sm mx-auto mt-20 text-center">
        <h1 class="text-4xl font-bold text-indigo-800 mb-6">🎶 Gestor de Ensayos</h1>
        <p class="text-gray-600 mb-8">Inicia sesión para continuar</p>
        <button id="login-btn" class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-xl transition-transform transform hover:scale-105 hover:bg-indigo-700 shadow-md flex items-center justify-center mx-auto">
            <svg class="w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="48px" height="48px"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.222,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C39.902,35.688,44,30.138,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg>
            Iniciar sesión con Google
        </button>
    </div>

    <!-- Contenedor principal de la aplicación (oculto por defecto) -->
    <div id="main-container" class="hidden bg-white rounded-3xl shadow-xl p-6 sm:p-8 max-w-2xl w-full space-y-6 md:space-y-8 mt-6">
        
        <!-- Perfil de usuario y botón de logout -->
        <div id="user-profile" class="flex items-center justify-between border-b pb-4">
            <div>
                <p class="text-lg font-semibold text-gray-800">Bienvenido, <span id="user-name"></span></p>
                <p class="text-sm text-gray-500" id="user-email"></p>
            </div>
            <button id="logout-btn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-xl transition-colors hover:bg-red-600">
                Cerrar Sesión
            </button>
        </div>

        <!-- Sección de Grupos -->
        <div id="groups-section" class="border-b pb-4">
            <div class="flex items-center justify-between mb-2">
                <h2 class="text-xl font-semibold text-gray-800">Mis Grupos</h2>
                <button id="create-group-btn" class="bg-green-500 text-white font-bold py-2 px-4 rounded-xl transition-colors hover:bg-green-600">Crear Grupo</button>
            </div>
            <div id="groups-list" class="space-y-2">
                <!-- Los grupos se listarán aquí -->
            </div>
        </div>

        <!-- Vista de la pantalla principal -->
        <div id="main-view">
            <!-- Título y ID de usuario -->
            <h1 class="text-3xl sm:text-4xl font-bold text-indigo-800 text-center">🎶 Gestor de Ensayos</h1>
            
            <!-- Sección para añadir una nueva canción -->
            <div id="add-song-section" class="p-3 bg-indigo-100 rounded-2xl shadow-inner mb-6">
                <h2 class="text-xl font-semibold text-indigo-700 mb-2">Añadir Nueva Canción</h2>
                <form id="add-song-form" class="flex flex-col space-y-3">
                    <input type="text" id="new-song-input" placeholder="Nombre de la canción..." required
                           class="w-full p-2 rounded-xl border border-indigo-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                    <input type="url" id="pdf-link-input" placeholder="Enlace a la Partitura (PDF)..." 
                           class="w-full p-2 rounded-xl border border-indigo-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                    <input type="url" id="video-link-input" placeholder="Enlace al Video..." 
                           class="w-full p-2 rounded-xl border border-indigo-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                    <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-2 px-5 rounded-xl transition-transform transform hover:scale-105 hover:bg-indigo-700 shadow-md">
                        Añadir
                    </button>
                </form>
            </div>
            
            <!-- Sección para iniciar un nuevo ensayo -->
            <div id="start-rehearsal-section" class="p-4 bg-purple-100 rounded-2xl shadow-inner mb-6">
                <h2 class="text-xl font-semibold text-purple-700 mb-3">Iniciar Nuevo Ensayo</h2>
                <form id="new-rehearsal-form" class="space-y-4">
                    <div>
                        <label for="rehearsal-date" class="block text-gray-700 font-semibold mb-1">Fecha:</label>
                        <input type="date" id="rehearsal-date" required class="w-full p-2 rounded-xl border border-purple-300 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <label for="rehearsal-duration" class="block text-gray-700 font-semibold mb-1">Duración (minutos):</label>
                        <input type="number" id="rehearsal-duration" min="1" value="60" required class="w-full p-2 rounded-xl border border-purple-300 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-1">Seleccionar Temas:</label>
                        <div id="songs-list-checkboxes" class="grid grid-cols-1 sm:grid-cols-2 gap-2 p-2 bg-purple-50 rounded-lg">
                            <div id="loading-songs" class="text-center text-gray-500 p-2">Cargando temas...</div>
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-purple-600 text-white font-bold py-3 rounded-xl transition-transform transform hover:scale-105 hover:bg-purple-700 shadow-md">
                        Comenzar Ensayo
                    </button>
                </form>
            </div>
            
            <!-- Sección para ver el historial por tema -->
            <div>
                <h2 class="text-xl font-semibold text-indigo-700 mb-2">Historial por Tema</h2>
                <div id="songs-list-clickable" class="grid grid-cols-1 sm:grid-cols-2 gap-2 p-2 bg-indigo-50 rounded-lg">
                    <div id="loading-songs-clickable" class="text-center text-gray-500 p-2">Cargando temas...</div>
                </div>
            </div>

            <!-- Lista de ensayos pasados -->
            <div class="mt-6">
                <h2 class="text-xl font-semibold text-indigo-700 mb-2">Historial de Ensayos</h2>
                <div id="rehearsal-history-list" class="space-y-2">
                    <div id="loading-history" class="text-center text-gray-500 p-4">Cargando historial...</div>
                </div>
            </div>
        </div>

        <!-- Vista del historial de una sola canción -->
        <div id="single-song-history-view" class="hidden">
            <button id="back-to-main-btn" class="flex items-center text-indigo-600 font-bold mb-4 hover:underline">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-left mr-1">
                    <path d="M19 12H5"/>
                    <path d="m12 19-7-7 7-7"/>
                </svg>
                Volver
            </button>
            <div class="flex items-center justify-between mb-2">
                <h2 id="song-history-title" class="text-3xl sm:text-4xl font-bold text-indigo-800"></h2>
                <button id="toggle-view-btn" class="p-2 bg-indigo-100 rounded-full shadow-md transition-transform transform hover:scale-110">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-area-chart">
                        <path d="M3 3v18h18"/>
                        <path d="M7 15l4-5 4 5 4-5"/>
                    </svg>
                    <svg id="calendar-icon" class="hidden" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar">
                        <path d="M8 2v4"/>
                        <path d="M16 2v4"/>
                        <rect width="18" height="18" x="3" y="4" rx="2"/>
                        <path d="M3 10h18"/>
                    </svg>
                </button>
            </div>
            <p id="song-history-average" class="text-xl text-gray-600 font-semibold text-center mb-6">Promedio General: <span class="font-bold text-purple-600"></span></p>
            
            <!-- Sección de enlaces a recursos -->
            <div id="song-history-links" class="p-4 bg-gray-100 rounded-2xl shadow-inner mb-6">
                <h3 class="text-xl font-semibold text-gray-700 mb-3">Recursos</h3>
                <!-- Los enlaces se insertarán aquí -->
            </div>

            <!-- Contenedor del gráfico para el historial de la canción (vista por defecto) -->
            <div id="chart-view" class="p-4 bg-white rounded-xl shadow-inner my-6 h-80">
                <h3 class="text-lg font-semibold text-gray-800 mb-2 text-center">Rendimiento histórico</h3>
                <canvas id="song-history-chart"></canvas>
            </div>

            <!-- Contenedor del calendario (inicialmente oculto) -->
            <div id="calendar-view" class="hidden p-4 bg-white rounded-xl shadow-inner my-6">
                <div class="flex items-center justify-between mb-4">
                    <button id="prev-month-btn" class="p-2 bg-indigo-200 rounded-full hover:bg-indigo-300 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-left"><path d="m15 18-6-6 6-6"/></svg>
                    </button>
                    <h3 id="current-month-display" class="text-xl font-semibold text-gray-800"></h3>
                    <button id="next-month-btn" class="p-2 bg-indigo-200 rounded-full hover:bg-indigo-300 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-right"><path d="m9 18 6-6-6-6"/></svg>
                    </button>
                </div>
                <div class="grid grid-cols-7 gap-2 text-center text-sm font-semibold text-gray-600 mb-2">
                    <span>Dom</span><span>Lun</span><span>Mar</span><span>Mié</span><span>Jue</span><span>Vie</span><span>Sáb</span>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-2">
                    <!-- Los días del calendario se renderizarán aquí -->
                </div>
            </div>
            
            <div id="song-history-list" class="space-y-4">
                <!-- El historial se renderizará aquí -->
            </div>
        </div>

        <!-- Vista del ensayo en curso -->
        <div id="rehearsal-view" class="hidden text-center space-y-6">
            <h2 class="text-2xl sm:text-3xl font-bold text-indigo-800">Ensayando:</h2>
            <h3 id="current-song-title" class="text-4xl sm:text-5xl font-extrabold text-purple-700"></h3>
            
            <!-- Sección de enlaces a recursos -->
            <div id="song-links" class="flex justify-center space-x-4 mb-4">
                <!-- Los botones para PDF y video se insertarán aquí -->
            </div>
            
            <div class="space-y-2">
                <div id="song-timer" class="text-5xl font-mono font-bold text-gray-800"></div>
                <div class="progress-bar w-full">
                    <div id="progress-fill" class="progress-fill"></div>
                </div>
                <p id="total-time-display" class="text-sm text-gray-500 font-mono"></p>
            </div>

            <p class="text-xl font-semibold text-gray-700">Califica tu rendimiento:</p>
            <div class="flex justify-center space-x-3 sm:space-x-4">
                <button data-rating="1" class="rating-btn bg-gray-200 text-gray-700 font-bold p-3 rounded-lg text-lg hover:bg-red-400 hover:text-white transition-colors">1</button>
                <button data-rating="2" class="rating-btn bg-gray-200 text-gray-700 font-bold p-3 rounded-lg text-lg hover:bg-orange-400 hover:text-white transition-colors">2</button>
                <button data-rating="3" class="rating-btn bg-gray-200 text-gray-700 font-bold p-3 rounded-lg text-lg hover:bg-yellow-400 hover:text-white transition-colors">3</button>
                <button data-rating="4" class="rating-btn bg-gray-200 text-gray-700 font-bold p-3 rounded-lg text-lg hover:bg-lime-400 hover:text-white transition-colors">4</button>
                <button data-rating="5" class="rating-btn bg-gray-200 text-gray-700 font-bold p-3 rounded-lg text-lg hover:bg-green-400 hover:text-white transition-colors">5</button>
            </div>
            
            <!-- Nuevo elemento para mostrar todas las calificaciones y el promedio -->
            <div class="mt-4 p-4 bg-gray-100 rounded-xl shadow-inner">
                <h4 class="text-lg font-semibold text-gray-700 mb-2">Calificaciones para este tema:</h4>
                <div id="current-song-ratings-list" class="flex flex-wrap justify-center gap-2 mb-2">
                    <!--  Las calificaciones se renderizarán aquí -->
                </div>
                <p id="current-song-average-rating" class="text-lg font-bold text-gray-800">Promedio: -</p>
            </div>


            <button id="next-song-btn" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl transition-transform transform hover:scale-105 hover:bg-indigo-700 shadow-md">
                Siguiente Tema
            </button>
            <button id="finish-rehearsal-btn" class="w-full bg-red-600 text-white font-bold py-3 rounded-xl transition-transform transform hover:scale-105 hover:bg-red-700 shadow-md">
                Terminar Ensayo
            </button>
        </div>
    </div>

    <!-- Modal para crear grupo -->
    <div id="create-group-modal" class="modal">
        <div class="modal-content">
            <span id="close-group-modal" class="close-button">&times;</span>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Crear Nuevo Grupo</h2>
            <form id="create-group-form">
                <input type="text" id="new-group-name" placeholder="Nombre del grupo" required class="w-full p-2 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 mb-4">
                <button type="submit" class="w-full bg-green-500 text-white font-bold py-2 px-4 rounded-xl transition-colors hover:bg-green-600">Crear</button>
            </form>
        </div>
    </div>

    <!-- Modal para gestionar miembros -->
    <div id="members-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <span id="close-members-modal" class="close-button">&times;</span>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Gestionar Miembros de <span id="members-group-name"></span></h2>
            
            <div id="members-list" class="space-y-2 mb-4">
                <!-- Member list will be rendered here -->
            </div>

            <form id="invite-member-form" class="flex flex-col space-y-3 border-t pt-4">
                <h3 class="text-xl font-semibold text-indigo-700 mb-2">Invitar Nuevo Miembro</h3>
                <input type="email" id="new-member-email" placeholder="Email del nuevo miembro..." required class="w-full p-2 rounded-xl border border-indigo-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <select id="new-member-role" class="w-full p-2 rounded-xl border border-indigo-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <option value="reader">Lector</option>
                    <option value="creator">Creador</option>
                </select>
                <button type="submit" class="w-full bg-green-500 text-white font-bold py-2 px-4 rounded-xl transition-colors hover:bg-green-600">Invitar</button>
            </form>
            <div id="delete-group-section" class="border-t pt-4 mt-4"></div>
        </div>
    </div>

    <!-- Modal para mensajes de error, información y alertas -->
    <div id="myModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <div id="modal-content-body">
                <p id="modal-message" class="text-lg text-gray-700 mb-4"></p>
                <div id="modal-buttons" class="flex justify-center space-x-4 hidden">
                    <button id="confirm-delete-btn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-xl transition-colors hover:bg-red-600">Sí, eliminar</button>
                    <button id="cancel-delete-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-xl transition-colors hover:bg-gray-400">Cancelar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Script de Firebase y lógica de la aplicación -->
    <!-- Script de Firebase y lógica de la aplicación -->
    <script type="module">
        // Import the necessary Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut, connectAuthEmulator } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, getDoc, setDoc, query, where, deleteDoc, updateDoc, deleteField, connectFirestoreEmulator } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getFunctions, httpsCallable, connectFunctionsEmulator } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";

        // Global variables provided by the canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let db, auth, functions, userId;
        let selectedGroupId = null;
        let userGroups = [];
        let rehearsalIdToDelete = null;
        let groupIdToDelete = null; // New variable for group deletion
        let songChart = null; // Variable for the chart instance
        let currentCalendarDate = new Date(); // New state for the calendar view
        let unsubscribeGroups = null;
        let unsubscribeSongs = null;
        let unsubscribeHistory = null;

        document.addEventListener('DOMContentLoaded', () => {
            // Get DOM elements
            const loginView = document.getElementById('login-view');
            const mainContainer = document.getElementById('main-container');
            const loginBtn = document.getElementById('login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const userNameEl = document.getElementById('user-name');
            const userEmailEl = document.getElementById('user-email');
            const groupsSection = document.getElementById('groups-section');
            const createGroupBtn = document.getElementById('create-group-btn');
            const groupsList = document.getElementById('groups-list');
            const createGroupModal = document.getElementById('create-group-modal');
            const closeGroupModal = document.getElementById('close-group-modal');
            const createGroupForm = document.getElementById('create-group-form');
            const newGroupNameInput = document.getElementById('new-group-name');
            const membersModal = document.getElementById('members-modal');
            const closeMembersModal = document.getElementById('close-members-modal');
            const membersGroupName = document.getElementById('members-group-name');
            const membersList = document.getElementById('members-list');
            const inviteMemberForm = document.getElementById('invite-member-form');
            const newMemberEmailInput = document.getElementById('new-member-email');
            const deleteGroupSection = document.getElementById('delete-group-section');
            
            const mainView = document.getElementById('main-view');
            const rehearsalView = document.getElementById('rehearsal-view');
            const singleSongHistoryView = document.getElementById('single-song-history-view');
            const backToMainBtn = document.getElementById('back-to-main-btn');
            const addSongForm = document.getElementById('add-song-form');
            const newSongInput = document.getElementById('new-song-input');
            const pdfLinkInput = document.getElementById('pdf-link-input');
            const videoLinkInput = document.getElementById('video-link-input');
            const newRehearsalForm = document.getElementById('new-rehearsal-form');
            const songsListCheckboxes = document.getElementById('songs-list-checkboxes');
            const songsListClickable = document.getElementById('songs-list-clickable');
            const startRehearsalBtn = document.getElementById('start-rehearsal-btn');
            const rehearsalHistoryList = document.getElementById('rehearsal-history-list');
            const songHistoryList = document.getElementById('song-history-list');
            const songHistoryTitle = document.getElementById('song-history-title');
            const songHistoryAverage = document.getElementById('song-history-average').querySelector('span');
            const songHistoryLinks = document.getElementById('song-history-links');
            const loadingSongs = document.getElementById('loading-songs');
            const loadingSongsClickable = document.getElementById('loading-songs-clickable');
            const loadingHistory = document.getElementById('loading-history');
            const currentSongTitleEl = document.getElementById('current-song-title');
            const songLinksContainer = document.getElementById('song-links');
            const songTimerEl = document.getElementById('song-timer');
            const totalTimeDisplayEl = document.getElementById('total-time-display');
            const nextSongBtn = document.getElementById('next-song-btn');
            const finishRehearsalBtn = document.getElementById('finish-rehearsal-btn');
            const progressFillEl = document.getElementById('progress-fill');
            const currentSongRatingsListEl = document.getElementById('current-song-ratings-list');
            const currentSongAverageRatingEl = document.getElementById('current-song-average-rating');
            const modal = document.getElementById('myModal');
            const modalMessage = document.getElementById('modal-message');
            const modalButtons = document.getElementById('modal-buttons');
            const closeButton = modal.querySelector('.close-button');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
            const toggleViewBtn = document.getElementById('toggle-view-btn');
            const chartView = document.getElementById('chart-view');
            const calendarView = document.getElementById('calendar-view');
            const calendarIcon = document.getElementById('calendar-icon');
            const chartIcon = toggleViewBtn.querySelector('.lucide-area-chart');
            const prevMonthBtn = document.getElementById('prev-month-btn');
            const nextMonthBtn = document.getElementById('next-month-btn');
            const currentMonthDisplay = document.getElementById('current-month-display');
            const calendarGrid = document.getElementById('calendar-grid');
            const addSongSection = document.getElementById('add-song-section');
            const startRehearsalSection = document.getElementById('start-rehearsal-section');


            // Rehearsal session state
            let allSongs = [];
            let allRehearsals = []; // New variable to store all rehearsals
            let rehearsalSession = {
                isActive: false,
                date: null,
                duration: 0,
                selectedSongs: [],
                currentSongIndex: 0,
                songTimeAllotted: 0,
                timerInterval: null,
                songTimeRemaining: 0,
                totalTimeElapsed: 0,
                ratings: []
            };
            
            // Modal functions
            function showMessage(message, isConfirmation = false, confirmationType = null) {
                modalMessage.innerText = message;
                if (isConfirmation) {
                    modalButtons.classList.remove('hidden');
                    confirmDeleteBtn.dataset.confirmationType = confirmationType;
                } else {
                    modalButtons.classList.add('hidden');
                }
                modal.style.display = 'flex';
            }

            function hideModal() {
                modal.style.display = 'none';
                rehearsalIdToDelete = null;
                groupIdToDelete = null;
            }

            closeButton.onclick = hideModal;
            closeGroupModal.onclick = () => createGroupModal.style.display = 'none';
            closeMembersModal.onclick = () => membersModal.style.display = 'none';

            window.onclick = function(event) {
                if (event.target == modal) {
                    hideModal();
                }
                if (event.target == createGroupModal) {
                    createGroupModal.style.display = 'none';
                }
                if (event.target == membersModal) {
                    membersModal.style.display = 'none';
                }
            }
            
            // Timer formatting
            function formatTime(seconds) {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                return `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
            }

            // Firebase Initialization
            async function initFirebase() {
                try {
                    const response = await fetch('/__/firebase/init.json');
                    const firebaseConfig = await response.json();
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    functions = getFunctions(app);

                    if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
                        console.log("Connecting to emulators");
                        connectAuthEmulator(auth, "http://localhost:9099");
                        connectFirestoreEmulator(db, "localhost", 8080);
                        connectFunctionsEmulator(functions, "localhost", 5001);
                    }
                    
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            userNameEl.innerText = user.displayName || 'Usuario';
                            userEmailEl.innerText = user.email;

                            await saveUserToFirestore(user);

                            loginView.classList.add('hidden');
                            mainContainer.classList.remove('hidden');
                            
                            listenForGroups();
                            document.getElementById('rehearsal-date').valueAsDate = new Date();
                        } else {
                            userId = null;
                            loginView.classList.remove('hidden');
                            mainContainer.classList.add('hidden');

                            // Clean up listeners and state
                            if (unsubscribeGroups) unsubscribeGroups();
                            if (unsubscribeSongs) unsubscribeSongs();
                            if (unsubscribeHistory) unsubscribeHistory();
                            allSongs = [];
                            allRehearsals = [];
                            userGroups = [];
                            selectedGroupId = null;
                            groupsList.innerHTML = '';
                            songsListCheckboxes.innerHTML = '';
                            songsListClickable.innerHTML = '';
                            rehearsalHistoryList.innerHTML = '';
                        }
                    });
                } catch (error) {
                    console.error("Error al inicializar Firebase:", error);
                    showMessage("Error al inicializar la aplicación. " + error.message);
                }
            }

            async function saveUserToFirestore(user) {
                const userRef = doc(db, "users", user.uid);
                const userDoc = await getDoc(userRef);
                if (!userDoc.exists()) {
                    await setDoc(userRef, {
                        name: user.displayName,
                        email: user.email,
                        createdAt: new Date()
                    });
                }
            }

            // --- Data Fetching and Rendering ---

            function listenForGroups() {
                if (!userId) return;
                if (unsubscribeGroups) unsubscribeGroups();
                const groupsCollectionRef = collection(db, 'groups');
                const q = query(groupsCollectionRef, where(`members.${userId}`, 'in', ['admin', 'reader', 'creator']));

                unsubscribeGroups = onSnapshot(q, (snapshot) => {
                    userGroups = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderGroups();
                    if (!selectedGroupId && userGroups.length > 0) {
                        selectGroup(userGroups[0].id);
                    } else if (selectedGroupId) {
                        const groupExists = userGroups.some(g => g.id === selectedGroupId);
                        if (!groupExists) {
                            selectedGroupId = userGroups.length > 0 ? userGroups[0].id : null;
                            if (selectedGroupId) {
                                selectGroup(selectedGroupId);
                            } else {
                                mainView.classList.add('hidden');
                            }
                        }
                        if (membersModal.style.display === 'flex') {
                            const group = userGroups.find(g => g.id === selectedGroupId);
                            if (group) {
                                openMembersModal(group.id, group.name);
                            } else {
                                membersModal.style.display = 'none';
                            }
                        }
                    }
                    updateUIVisibility();
                });
            }

            function renderGroups() {
                groupsList.innerHTML = '';
                if (userGroups.length === 0) {
                    groupsList.innerHTML = `<p class="text-center text-gray-500">No perteneces a ningún grupo. ¡Crea uno!</p>`;
                    mainView.classList.add('hidden');
                } else {
                    mainView.classList.remove('hidden');
                    userGroups.forEach(group => {
                        const groupElWrapper = document.createElement('div');
                        groupElWrapper.className = 'flex items-center space-x-2';

                        const groupEl = document.createElement('button');
                        groupEl.dataset.groupId = group.id;
                        groupEl.textContent = group.name;
                        groupEl.className = `w-full text-left p-2 rounded-lg font-semibold`;
                        if (group.id === selectedGroupId) {
                            groupEl.classList.add('bg-indigo-600', 'text-white');
                        } else {
                            groupEl.classList.add('bg-gray-200', 'text-gray-800', 'hover:bg-indigo-200');
                        }
                        groupEl.addEventListener('click', () => selectGroup(group.id));
                        groupElWrapper.appendChild(groupEl);

                        if (group.members[userId] === 'admin') {
                            const manageBtn = document.createElement('button');
                            manageBtn.textContent = 'Gestionar';
                            manageBtn.className = 'bg-blue-500 text-white font-bold py-1 px-3 rounded-lg text-sm hover:bg-blue-600';
                            manageBtn.dataset.groupId = group.id;
                            manageBtn.dataset.groupName = group.name;
                            manageBtn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                openMembersModal(group.id, group.name);
                            });
                            groupElWrapper.appendChild(manageBtn);
                        }

                        groupsList.appendChild(groupElWrapper);
                    });
                }
            }

            function selectGroup(groupId) {
                selectedGroupId = groupId;
                renderGroups();
                listenForSongs();
                listenForRehearsalHistory();
                updateUIVisibility();
            }

            function updateUIVisibility() {
                if (!selectedGroupId || !userId) return;

                const selectedGroup = userGroups.find(g => g.id === selectedGroupId);
                if (!selectedGroup) return;

                const userRole = selectedGroup.members[userId];

                if (userRole === 'admin' || userRole === 'creator') {
                    addSongSection.style.display = 'block';
                    startRehearsalSection.style.display = 'block';
                } else {
                    addSongSection.style.display = 'none';
                    startRehearsalSection.style.display = 'none';
                }
            }
            
            function listenForSongs() {
                if (!selectedGroupId) return;
                if (unsubscribeSongs) unsubscribeSongs();
                const songsCollectionRef = collection(db, `groups/${selectedGroupId}/songs`);
                unsubscribeSongs = onSnapshot(songsCollectionRef, (snapshot) => {
                    allSongs = snapshot.docs.map(doc => ({
                        id: doc.id, 
                        name: doc.data().name,
                        pdfLink: doc.data().pdfLink || null,
                        videoLink: doc.data().videoLink || null
                    }));
                    renderSongsForSelection();
                    renderSongsForHistory();
                    loadingSongs.classList.add('hidden');
                    loadingSongsClickable.classList.add('hidden');
                }, (error) => {
                    console.error("Error listening for songs:", error);
                });
            }
            
            function renderSongsForSelection() {
                songsListCheckboxes.innerHTML = '';
                if (allSongs.length === 0) {
                    songsListCheckboxes.innerHTML = `<p class="text-center text-gray-500">Añade temas para empezar.</p>`;
                } else {
                    allSongs.forEach(song => {
                        const div = document.createElement('div');
                        div.innerHTML = `
                            <label class="inline-flex items-center">
                                <input type="checkbox" name="selected-song" value="${song.id}" data-name="${song.name}" 
                                       data-pdf-link="${song.pdfLink || ''}" data-video-link="${song.videoLink || ''}" 
                                       class="rounded text-purple-600 focus:ring-purple-500">
                                <span class="ml-2 text-gray-800">${song.name}</span>
                            </label>
                        `;
                        songsListCheckboxes.appendChild(div);
                    });
                }
            }

            function renderSongsForHistory() {
                songsListClickable.innerHTML = '';
                if (allSongs.length === 0) {
                    songsListClickable.innerHTML = `<p class="text-center text-gray-500">Añade temas para ver el historial.</p>`;
                } else {
                    allSongs.forEach(song => {
                        const allRatingsForSong = allRehearsals
                            .flatMap(rehearsal => rehearsal.songs)
                            .filter(rehearsalSong => rehearsalSong.name === song.name)
                            .flatMap(rehearsalSong => rehearsalSong.ratings || []);

                        const average = calculateAverage(allRatingsForSong);

                        const button = document.createElement('button');
                        button.classList.add('p-3', 'bg-white', 'rounded-xl', 'shadow-md', 'text-left', 'hover:bg-indigo-200', 'transition-colors', 'w-full');
                        button.dataset.songId = song.id;
                        button.dataset.songName = song.name;
                        button.innerHTML = `
                            <div class="flex justify-between items-center w-full">
                                <span class="font-semibold text-gray-800">${song.name}</span>
                                <span class="font-bold text-purple-600 text-lg">${average}</span>
                            </div>
                        `;
                        songsListClickable.appendChild(button);
                    });
                }
            }

            function listenForRehearsalHistory() {
                if (!selectedGroupId) return;
                if (unsubscribeHistory) unsubscribeHistory();
                const historyCollectionRef = collection(db, `groups/${selectedGroupId}/rehearsals`);
                unsubscribeHistory = onSnapshot(historyCollectionRef, (snapshot) => {
                    allRehearsals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderRehearsalHistory(allRehearsals);
                    loadingHistory.classList.add('hidden');
                }, (error) => {
                    console.error("Error listening for rehearsal history:", error);
                });
            }

            function renderRehearsalHistory(rehearsals) {
                rehearsalHistoryList.innerHTML = '';
                if (rehearsals.length === 0) {
                    rehearsalHistoryList.innerHTML = `<p class="text-center text-gray-500">Aún no hay ensayos registrados.</p>`;
                    return;
                }
                rehearsals.sort((a, b) => new Date(b.date) - new Date(a.date));
                rehearsals.forEach(rehearsal => {
                    const songInfoHtml = rehearsal.songs.map(song => 
                        `<div class="text-sm font-medium text-gray-700">${song.name} (${calculateAverage(song.ratings)})</div>`
                    ).join('');

                    const rehearsalEl = document.createElement('div');
                    rehearsalEl.classList.add('p-3', 'bg-white', 'rounded-xl', 'shadow-md', 'flex', 'flex-col', 'space-y-2');
                    rehearsalEl.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-base font-semibold text-gray-800">
                                    Ensayo del ${rehearsal.date}
                                    <span class="text-sm text-gray-500 font-normal">(${rehearsal.duration} min)</span>
                                </p>
                            </div>
                            <button data-id="${rehearsal.id}" class="delete-rehearsal-btn bg-red-500 text-white p-1.5 rounded-full shadow-md transition-transform transform hover:scale-110 hover:bg-red-600">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                            </button>
                        </div>
                        <div class="flex flex-col space-y-1 mt-2">
                            ${songInfoHtml}
                        </div>
                    `;
                    rehearsalHistoryList.appendChild(rehearsalEl);
                });
            }

            function calculateAverage(ratings) {
                if (!ratings || ratings.length === 0) return 'N/A';
                const sum = ratings.reduce((total, rating) => total + rating, 0);
                return (sum / ratings.length).toFixed(2);
            }

            function renderCurrentSongRatings(ratings) {
                currentSongRatingsListEl.innerHTML = '';
                if (!ratings || ratings.length === 0) {
                    currentSongRatingsListEl.innerHTML = '<span class="text-gray-500">Sin calificaciones aún.</span>';
                }
                else {
                    ratings.forEach(rating => {
                        const ratingSpan = document.createElement('span');
                        ratingSpan.classList.add('bg-gray-200', 'text-gray-700', 'font-bold', 'px-3', 'py-1', 'rounded-full');
                        ratingSpan.innerText = rating;
                        currentSongRatingsListEl.appendChild(ratingSpan);
                    });
                }
                currentSongAverageRatingEl.innerText = `Promedio: ${calculateAverage(ratings)}`;
            }

            // --- Member Management ---
            async function openMembersModal(groupId, groupName) {
                membersGroupName.textContent = groupName;
                membersModal.dataset.groupId = groupId;
                
                const group = userGroups.find(g => g.id === groupId);
                if (!group) return;

                membersList.innerHTML = '<div class="text-center text-gray-500 p-2">Cargando miembros...</div>';
                deleteGroupSection.innerHTML = ''; // Clear delete button

                const memberUIDs = Object.keys(group.members);
                const userDocs = await Promise.all(memberUIDs.map(uid => getDoc(doc(db, 'users', uid))));
                const memberDetails = userDocs
                    .filter(doc => doc.exists())
                    .map(userDoc => ({
                        uid: userDoc.id,
                        ...userDoc.data()
                    }));

                renderMembers(group, memberDetails);

                // Show delete button if admin and last member
                if (group.owner === userId && memberDetails.length === 1) {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Eliminar Grupo Permanentemente';
                    deleteBtn.className = 'w-full bg-red-600 text-white font-bold py-2 px-4 rounded-xl mt-4 transition-colors hover:bg-red-700';
                    deleteBtn.addEventListener('click', () => {
                        groupIdToDelete = groupId;
                        showMessage(`¿Estás seguro de que quieres eliminar el grupo "${group.name}"? Esta acción es irreversible y borrará todas sus canciones y ensayos.`, true, 'group');
                    });
                    deleteGroupSection.appendChild(deleteBtn);
                }

                membersModal.style.display = 'flex';
            }

            function renderMembers(group, memberDetails) {
                membersList.innerHTML = '';
                memberDetails.forEach(member => {
                    const memberEl = document.createElement('div');
                    memberEl.className = 'flex items-center justify-between p-2 bg-gray-100 rounded-lg';
                    
                    const memberInfo = document.createElement('div');
                    memberInfo.className = 'text-left';
                    memberInfo.innerHTML = `
                        <p class="font-semibold text-gray-800">${member.name || member.email}</p>
                        <p class="text-sm text-gray-500">${member.email}</p>
                    `;

                    const memberActions = document.createElement('div');
                    memberActions.className = 'flex items-center space-x-2';

                    const roleSelect = document.createElement('select');
                    roleSelect.className = 'p-1 rounded-md border-gray-300';
                    roleSelect.dataset.uid = member.uid;
                    
                    const optionAdmin = document.createElement('option');
                    optionAdmin.value = 'admin';
                    optionAdmin.textContent = 'Admin';
                    if (group.members[member.uid] === 'admin') optionAdmin.selected = true;
                    
                    const optionReader = document.createElement('option');
                    optionReader.value = 'reader';
                    optionReader.textContent = 'Lector';
                    if (group.members[member.uid] === 'reader') optionReader.selected = true;

                    const optionCreator = document.createElement('option');
                    optionCreator.value = 'creator';
                    optionCreator.textContent = 'Creador';
                    if (group.members[member.uid] === 'creator') optionCreator.selected = true;

                    roleSelect.appendChild(optionAdmin);
                    roleSelect.appendChild(optionCreator);
                    roleSelect.appendChild(optionReader);
                    
                    if (group.owner === member.uid) {
                        roleSelect.disabled = true;
                    }

                    roleSelect.addEventListener('change', (e) => {
                        updateMemberRole(group.id, member.uid, e.target.value);
                    });

                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'bg-red-500 text-white p-1.5 rounded-full shadow-md transition-transform transform hover:scale-110 hover:bg-red-600';
                    removeBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>';
                    
                    if (group.owner === member.uid) {
                        removeBtn.disabled = true;
                        removeBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    } else {
                        removeBtn.addEventListener('click', () => {
                            removeMember(group.id, member.uid);
                        });
                    }

                    memberActions.appendChild(roleSelect);
                    memberActions.appendChild(removeBtn);
                    
                    memberEl.appendChild(memberInfo);
                    memberEl.appendChild(memberActions);
                    membersList.appendChild(memberEl);
                });
            }

            async function updateMemberRole(groupId, memberUid, newRole) {
                const groupRef = doc(db, 'groups', groupId);
                try {
                    await updateDoc(groupRef, {
                        [`members.${memberUid}`]: newRole
                    });
                    showMessage('Rol actualizado correctamente.');
                } catch (error) {
                    console.error("Error updating role:", error);
                    showMessage('Error al actualizar el rol.');
                }
            }

            async function removeMember(groupId, memberUid) {
                const groupRef = doc(db, 'groups', groupId);
                try {
                    await updateDoc(groupRef, {
                        [`members.${memberUid}`]: deleteField()
                    });
                    showMessage('Miembro eliminado correctamente.');
                } catch (error) {
                    console.error("Error removing member:", error);
                    showMessage('Error al eliminar el miembro.');
                }
            }

            inviteMemberForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = newMemberEmailInput.value.trim();
                const role = document.getElementById('new-member-role').value;
                const groupId = membersModal.dataset.groupId;
                const user = auth.currentUser;

                if (email && groupId && user) {
                    try {
                        const idToken = await user.getIdToken();
                        const isLocal = window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1";
                        const projectId = firebaseConfig.projectId;
                        const functionUrl = isLocal 
                            ? `http://localhost:5001/${projectId}/us-central1/inviteUserToGroup`
                            : `https://us-central1-${projectId}.cloudfunctions.net/inviteUserToGroup`;

                        const response = await fetch(functionUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${idToken}`
                            },
                            body: JSON.stringify({ data: { email, groupId, role } })
                        });

                        const result = await response.json();

                        if (!response.ok) {
                            throw new Error(result.error.message || 'An unknown error occurred.');
                        }

                        showMessage(result.data.message);
                        newMemberEmailInput.value = '';
                    } catch (error) {
                        console.error("Error inviting user:", error);
                        showMessage(`Error: ${error.message}`);
                    }
                }
            });

            // --- Event Listeners and Logic ---

            loginBtn.addEventListener('click', async () => {
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(auth, provider);
                } catch (error) {
                    console.error("Error durante el inicio de sesión con Google:", error);
                    showMessage("Error al iniciar sesión: " + error.message);
                }
            });

            logoutBtn.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                }
                catch (error) {
                    console.error("Error durante el cierre de sesión:", error);
                    showMessage("Error al cerrar sesión.");
                }
            });

            createGroupBtn.addEventListener('click', () => {
                createGroupModal.style.display = 'flex';
            });

            createGroupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const groupName = newGroupNameInput.value.trim();
                if (groupName && userId) {
                    try {
                        const groupsCollectionRef = collection(db, 'groups');
                        await addDoc(groupsCollectionRef, {
                            name: groupName,
                            owner: userId,
                            createdAt: new Date(),
                            members: {
                                [userId]: 'admin'
                            }
                        });
                        newGroupNameInput.value = '';
                        createGroupModal.style.display = 'none';
                    } catch (error) {
                        console.error("Error creating group:", error);
                        showMessage("Error al crear el grupo.");
                    }
                }
            });

            groupsList.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (button && !button.dataset.groupName) { // Ensure it's not the manage button
                    const groupId = button.dataset.groupId;
                    selectGroup(groupId);
                }
            });

            addSongForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const songName = newSongInput.value.trim();
                const pdfLink = pdfLinkInput.value.trim();
                const videoLink = videoLinkInput.value.trim();

                if (songName === "") {
                    showMessage("El nombre de la canción no puede estar vacío.");
                    return;
                }
                if (!userId || !selectedGroupId) {
                    showMessage("Debes seleccionar un grupo para añadir canciones.");
                    return;
                }
                try {
                    const songsCollectionRef = collection(db, `groups/${selectedGroupId}/songs`);
                    await addDoc(songsCollectionRef, { 
                        name: songName,
                        pdfLink: pdfLink,
                        videoLink: videoLink,
                        createdBy: userId,
                        createdAt: new Date()
                    });
                    newSongInput.value = '';
                    pdfLinkInput.value = '';
                    videoLinkInput.value = '';
                } catch (e) {
                    console.error("Error al añadir la canción:", e);
                    showMessage("Error al añadir la canción. Intente de nuevo.");
                }
            });

            newRehearsalForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const date = document.getElementById('rehearsal-date').value;
                const duration = parseInt(document.getElementById('rehearsal-duration').value, 10);
                const selectedSongs = Array.from(document.querySelectorAll('input[name="selected-song"]:checked')).map(cb => ({
                    id: cb.value,
                    name: cb.dataset.name,
                    pdfLink: cb.dataset.pdfLink,
                    videoLink: cb.dataset.videoLink,
                    ratings: []
                }));

                if (selectedSongs.length === 0) {
                    showMessage("Debes seleccionar al menos un tema para el ensayo.");
                    return;
                }
                if (duration <= 0) {
                    showMessage("La duración del ensayo debe ser al menos 1 minuto.");
                    return;
                }

                rehearsalSession.isActive = true;
                rehearsalSession.date = date;
                rehearsalSession.duration = duration;
                rehearsalSession.selectedSongs = selectedSongs;
                rehearsalSession.currentSongIndex = 0;
                rehearsalSession.totalTimeElapsed = 0;
                rehearsalSession.songTimeAllotted = (duration * 60) / selectedSongs.length;
                rehearsalSession.songTimeRemaining = rehearsalSession.songTimeAllotted;
                
                renderCurrentSongRatings(rehearsalSession.selectedSongs[rehearsalSession.currentSongIndex].ratings);
                renderSongLinks();

                mainView.classList.add('hidden');
                rehearsalView.classList.remove('hidden');
                singleSongHistoryView.classList.add('hidden');
                startSongTimer();
            });

            function renderSongLinks() {
                const song = rehearsalSession.selectedSongs[rehearsalSession.currentSongIndex];
                const songLinksContainer = document.getElementById('song-links');
                songLinksContainer.innerHTML = ''; // Clear previous links

                if (!song) return;

                if (song.pdfLink) {
                    const pdfButton = document.createElement('a');
                    pdfButton.href = song.pdfLink;
                    pdfButton.target = '_blank';
                    pdfButton.textContent = 'Ver Partitura (PDF)';
                    pdfButton.className = 'bg-blue-500 text-white font-bold py-2 px-4 rounded-xl transition-colors hover:bg-blue-600';
                    songLinksContainer.appendChild(pdfButton);
                }

                if (song.videoLink) {
                    const videoButton = document.createElement('a');
                    videoButton.href = song.videoLink;
                    videoButton.target = '_blank';
                    videoButton.textContent = 'Ver Video';
                    videoButton.className = 'bg-red-500 text-white font-bold py-2 px-4 rounded-xl transition-colors hover:bg-red-600';
                    songLinksContainer.appendChild(videoButton);
                }
            }

            function startSongTimer() {
                if (rehearsalSession.timerInterval) {
                    clearInterval(rehearsalSession.timerInterval);
                }
                updateRehearsalDisplay();
                
                rehearsalSession.timerInterval = setInterval(() => {
                    rehearsalSession.songTimeRemaining--;
                    rehearsalSession.totalTimeElapsed++;
                    updateRehearsalDisplay();
                    
                    if (rehearsalSession.songTimeRemaining <= 0) {
                        clearInterval(rehearsalSession.timerInterval);
                        showMessage("¡Tiempo terminado para este tema! Presiona Siguiente para continuar.");
                    }
                }, 1000);
            }

            function updateRehearsalDisplay() {
                const currentSong = rehearsalSession.selectedSongs[rehearsalSession.currentSongIndex];
                currentSongTitleEl.innerText = currentSong.name;
                songTimerEl.innerText = formatTime(rehearsalSession.songTimeRemaining);
                totalTimeDisplayEl.innerText = `Tiempo total transcurrido: ${formatTime(rehearsalSession.totalTimeElapsed)}`;
                const progressPercentage = (rehearsalSession.songTimeAllotted - rehearsalSession.songTimeRemaining) / rehearsalSession.songTimeAllotted * 100;
                progressFillEl.style.width = `${Math.min(100, progressPercentage)}%`;
            }

            function renderSongHistoryLinks(song) {
                songHistoryLinks.innerHTML = '';
                if (!song) return;

                let linksHtml = '';
                if (song.pdfLink) {
                    linksHtml += `<a href="${song.pdfLink}" target="_blank" class="text-blue-500 hover:underline">Partitura (PDF)</a>`;
                }
                if (song.videoLink) {
                    linksHtml += `${linksHtml ? '<br>' : ''}<a href="${song.videoLink}" target="_blank" class="text-blue-500 hover:underline">Video</a>`;
                }

                const selectedGroup = userGroups.find(g => g.id === selectedGroupId);
                if (selectedGroup && selectedGroup.members[userId] === 'admin') {
                    linksHtml += `<button data-song-id="${song.id}" class="edit-song-links-btn bg-blue-500 text-white font-bold py-1 px-3 rounded-lg text-sm hover:bg-blue-600 ml-4">Editar</button>`;
                }

                songHistoryLinks.innerHTML = linksHtml || '<p class="text-gray-500">No hay enlaces para este tema.</p>';
            }

            function showSongHistory(songId, songName) {
                mainView.classList.add('hidden');
                rehearsalView.classList.add('hidden');
                singleSongHistoryView.classList.remove('hidden');
                
                if (songChart) {
                    songChart.destroy();
                }

                songHistoryTitle.innerText = songName;
                songHistoryList.innerHTML = '';
                
                const song = allSongs.find(s => s.id === songId);
                renderSongHistoryLinks(song);
                
                const relevantEntries = allRehearsals
                    .map(rehearsal => {
                        const songEntry = rehearsal.songs.find(s => s.name === songName);
                        return songEntry ? { date: rehearsal.date, ratings: songEntry.ratings } : null;
                    })
                    .filter(entry => entry !== null);
                
                if (relevantEntries.length === 0) {
                    songHistoryList.innerHTML = `<p class="text-center text-gray-500">No hay datos de calificación para este tema aún.</p>`;
                    songHistoryAverage.innerText = '0.00';
                    return;
                }

                let totalRating = 0;
                let ratingCount = 0;
                const chartLabels = [];
                const chartData = [];
                const ratingsByDate = {};

                relevantEntries.sort((a, b) => new Date(a.date) - new Date(b.date));

                relevantEntries.forEach(entry => {
                    const average = calculateAverage(entry.ratings);
                    totalRating += parseFloat(average) * entry.ratings.length;
                    ratingCount += entry.ratings.length;
                    ratingsByDate[entry.date] = average;

                    chartLabels.push(entry.date);
                    chartData.push(parseFloat(average));

                    const rehearsalEntry = document.createElement('div');
                    rehearsalEntry.classList.add('p-4', 'bg-white', 'rounded-xl', 'shadow-md');
                    rehearsalEntry.innerHTML = `
                        <p class="text-gray-800 font-semibold mb-1">Ensayo del ${entry.date}</p>
                        <p class="text-sm text-gray-600 mb-2">Calificaciones: ${entry.ratings.join(', ')}</p>
                        <p class="text-lg font-bold text-indigo-600">Promedio: ${average}</p>
                    `;
                    songHistoryList.appendChild(rehearsalEntry);
                });

                const ctx = document.getElementById('song-history-chart').getContext('2d');
                songChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: chartLabels,
                        datasets: [{
                            label: 'Calificación Promedio',
                            data: chartData,
                            borderColor: 'rgb(79, 70, 229)',
                            backgroundColor: 'rgba(79, 70, 229, 0.2)',
                            tension: 0.2,
                            pointBackgroundColor: 'rgb(79, 70, 229)',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: 'rgb(79, 70, 229)',
                            fill: true,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, max: 5, title: { display: true, text: 'Calificación', font: { weight: 'bold' } } },
                            x: { title: { display: true, text: 'Fecha del Ensayo', font: { weight: 'bold' } } }
                        },
                        plugins: { legend: { display: false } }
                    }
                });

                const overallAverage = ratingCount > 0 ? (totalRating / ratingCount).toFixed(2) : '0.00';
                songHistoryAverage.innerText = overallAverage;
                
                currentCalendarDate = new Date();
                renderCalendar(ratingsByDate);
            }

            toggleViewBtn.addEventListener('click', () => {
                const isChartView = !chartView.classList.contains('hidden');
                chartView.classList.toggle('hidden', isChartView);
                calendarView.classList.toggle('hidden', !isChartView);
                chartIcon.classList.toggle('hidden', isChartView);
                calendarIcon.classList.toggle('hidden', !isChartView);
            });

            function renderCalendar(ratingsData) {
                calendarGrid.innerHTML = '';
                const year = currentCalendarDate.getFullYear();
                const month = currentCalendarDate.getMonth();
                const monthName = new Date(year, month).toLocaleString('es-ES', { month: 'long', year: 'numeric' });
                currentMonthDisplay.innerText = monthName.charAt(0).toUpperCase() + monthName.slice(1);

                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                for (let i = 0; i < firstDayOfMonth; i++) {
                    calendarGrid.appendChild(document.createElement('div'));
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const cell = document.createElement('div');
                    cell.classList.add('p-2', 'rounded-xl', 'text-center', 'font-bold', 'flex', 'flex-col', 'items-center', 'justify-center', 'shadow-inner');
                    const currentDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    
                    if (ratingsData[currentDate]) {
                        cell.classList.add('bg-indigo-200');
                        cell.innerHTML = `<span class="text-sm text-gray-800">${day}</span><span class="text-xs text-indigo-700 font-semibold mt-1">${ratingsData[currentDate]}</span>`;
                    } else {
                        cell.classList.add('bg-gray-100', 'text-gray-400');
                        cell.innerHTML = `<span class="text-sm">${day}</span>`;
                    }
                    calendarGrid.appendChild(cell);
                }
            }

            function navigateCalendar(offset) {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() + offset);
                const songName = songHistoryTitle.innerText;
                const relevantEntries = allRehearsals
                    .map(rehearsal => {
                        const songEntry = rehearsal.songs.find(s => s.name === songName);
                        return songEntry ? { date: rehearsal.date, ratings: songEntry.ratings } : null;
                    })
                    .filter(entry => entry !== null);
                const ratingsByDate = {};
                relevantEntries.forEach(entry => {
                    ratingsByDate[entry.date] = calculateAverage(entry.ratings);
                });
                renderCalendar(ratingsByDate);
            }

            prevMonthBtn.addEventListener('click', () => navigateCalendar(-1));
            nextMonthBtn.addEventListener('click', () => navigateCalendar(1));
            
            backToMainBtn.addEventListener('click', () => {
                singleSongHistoryView.classList.add('hidden');
                mainView.classList.remove('hidden');
            });

            songsListClickable.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (button && button.dataset.songId) {
                    const songId = button.dataset.songId;
                    const songName = button.dataset.songName;
                    showSongHistory(songId, songName);
                }
            });

            rehearsalView.addEventListener('click', (e) => {
                if (e.target.classList.contains('rating-btn')) {
                    const rating = parseInt(e.target.dataset.rating, 10);
                    const currentSong = rehearsalSession.selectedSongs[rehearsalSession.currentSongIndex];
                    if (currentSong) {
                        if (!currentSong.ratings) {
                            currentSong.ratings = [];
                        }
                        currentSong.ratings.push(rating);
                        renderCurrentSongRatings(currentSong.ratings);
                    }
                }
            });

            nextSongBtn.addEventListener('click', () => {
                clearInterval(rehearsalSession.timerInterval);
                rehearsalSession.currentSongIndex++;
                if (rehearsalSession.currentSongIndex >= rehearsalSession.selectedSongs.length) {
                    finishRehearsal();
                } else {
                    rehearsalSession.songTimeRemaining = rehearsalSession.songTimeAllotted;
                    const currentSong = rehearsalSession.selectedSongs[rehearsalSession.currentSongIndex];
                    renderCurrentSongRatings(currentSong.ratings || []);
                    renderSongLinks();
                    startSongTimer();
                }
            });

            async function finishRehearsal() {
                clearInterval(rehearsalSession.timerInterval);
                if (!rehearsalSession.isActive) return;
                rehearsalSession.isActive = false;

                const rehearsalData = {
                    date: rehearsalSession.date,
                    duration: rehearsalSession.duration,
                    songs: rehearsalSession.selectedSongs.map(song => ({
                        id: song.id,
                        name: song.name,
                        ratings: song.ratings || []
                    })),
                    completedAt: new Date(),
                    userId: userId
                };

                try {
                    if (!selectedGroupId) throw new Error("No group selected");
                    const historyCollectionRef = collection(db, `groups/${selectedGroupId}/rehearsals`);
                    await addDoc(historyCollectionRef, rehearsalData);
                    showMessage("¡Ensayo guardado con éxito!");
                } catch (error) {
                    console.error("Error saving rehearsal:", error);
                    showMessage("Error al guardar el ensayo: " + error.message);
                }

                rehearsalView.classList.add('hidden');
                mainView.classList.remove('hidden');
            }

            finishRehearsalBtn.addEventListener('click', finishRehearsal);

            console.log('Attempting to attach listener to rehearsalHistoryList');
            if (rehearsalHistoryList) {
                rehearsalHistoryList.addEventListener('click', (e) => {
                    console.log('Click detected on history list. Target:', e.target);
                    const deleteBtn = e.target.closest('.delete-rehearsal-btn');
                    if (deleteBtn) {
                        console.log('Delete button found!', deleteBtn);
                        rehearsalIdToDelete = deleteBtn.dataset.id;
                        showMessage(`¿Estás seguro de que quieres eliminar este ensayo? Esta acción no se puede deshacer.`, true, 'rehearsal');
                    }
                });
                console.log('Listener attached successfully.');
            } else {
                console.error('Error: rehearsalHistoryList element not found!');
            }

            confirmDeleteBtn.addEventListener('click', async () => {
                const type = confirmDeleteBtn.dataset.confirmationType;
                if (type === 'group') {
                    if (groupIdToDelete) {
                        // Unsubscribe from listeners before deleting
                        if (unsubscribeSongs) unsubscribeSongs();
                        if (unsubscribeHistory) unsubscribeHistory();

                        try {
                            const user = auth.currentUser;
                            if (!user) throw new Error("User not authenticated.");
                            const idToken = await user.getIdToken();
                            
                            const isLocal = window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1";
                            const projectId = firebaseConfig.projectId;
                            const functionUrl = isLocal 
                                ? `http://localhost:5001/${projectId}/us-central1/deleteGroup`
                                : `https://us-central1-${projectId}.cloudfunctions.net/deleteGroup`;

                            const response = await fetch(functionUrl, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${idToken}`
                                },
                                body: JSON.stringify({ data: { groupId: groupIdToDelete } })
                            });

                            if (!response.ok) {
                                const errorData = await response.json();
                                throw new Error(errorData.error.message || 'Failed to delete group.');
                            }

                            showMessage('Grupo eliminado con éxito.');
                            membersModal.style.display = 'none';
                        } catch (error) {
                            console.error('Error deleting group:', error);
                            showMessage(`Error al eliminar el grupo: ${error.message}`);
                        }
                        hideModal();
                    }
                } else if (type === 'rehearsal') {
                    if (rehearsalIdToDelete && selectedGroupId) {
                        try {
                            const rehearsalRef = doc(db, 'groups', selectedGroupId, 'rehearsals', rehearsalIdToDelete);
                            await deleteDoc(rehearsalRef);
                            showMessage('Ensayo eliminado correctamente.');
                        } catch (error) {
                            console.error("Error deleting rehearsal:", error);
                            showMessage(`Error al eliminar el ensayo: ${error.message}`);
                        }
                        hideModal();
                    }
                }
            });

            initFirebase(); // Call initFirebase here
        });
    </script>
</body><!-- Trigger redeploy -->
</html>